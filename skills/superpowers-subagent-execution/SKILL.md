---
name: superpowers-subagent-execution
description: 子智能体驱动开发 - 在当前会话中执行实现计划，每个任务分派新的子智能体，两阶段审查（规范合规性 + 代码质量）
version: 1.0.0
category: automation
---

# 子智能体驱动开发

通过为每个任务分派新的子智能体来执行计划，每个任务完成后进行两阶段审查：先规范合规性审查，再代码质量审查。

**核心原则：** 每个任务使用新子智能体 + 两阶段审查（规范后质量）= 高质量、快速迭代

**开始时声明：** "我正在使用 superpowers-subagent-execution 技能来执行此计划。"

## 何时使用

**决策流程：**
```
有实现计划？
  ↓ 是
任务大多独立？
  ↓ 是
留在当前会话？
  ↓ 是
→ 使用 subagent-driven-development
```

**vs. 并行会话执行（executing-plans）：**
- 同一会话（无上下文切换）
- 每个任务使用新子智能体（无上下文污染）
- 每个任务后两阶段审查：先规范合规性，再代码质量
- 更快迭代（任务间无需人工介入）

## 流程

### 整体流程

```
1. 读取计划，提取所有任务（含完整文本），记录上下文，创建 TodoWrite
2. 对每个任务：
   a. 分派实现者子智能体
   b. 实现者有问题？→ 回答问题，提供上下文
   c. 实现者实现、测试、提交、自我审查
   d. 分派规范审查者子智能体
   e. 规范审查通过？否 → 实现者修复 → 重新规范审查
   f. 分派代码质量审查者子智能体
   g. 代码质量审查通过？否 → 实现者修复 → 重新代码质量审查
   h. 在 TodoWrite 中标记任务完成
3. 所有任务完成后：
   a. 分派最终代码审查者子智能体
   b. 使用 superpowers-finishing-branch 完成开发
```

### 每个任务的详细流程

**步骤 1：分派实现者**
- 使用 `./implementer-prompt.md` 模板
- 提供完整任务文本 + 上下文
- 允许实现者提问

**步骤 2：实现者工作**
- 实现功能
- 编写测试
- 提交代码
- 自我审查

**步骤 3：规范合规性审查**
- 使用 `./spec-reviewer-prompt.md` 模板
- 验证实现是否符合规格
- 检查过度实现或不足实现
- 如有问题 → 实现者修复 → 重新审查

**步骤 4：代码质量审查**
- 使用 `./code-quality-reviewer-prompt.md` 模板
- 验证代码风格、性能、安全性
- 仅在规范审查通过后进行
- 如有问题 → 实现者修复 → 重新审查

**步骤 5：标记完成**
- 在 TodoWrite 中标记任务完成
- 继续下一个任务

## 提示模板

- `./implementer-prompt.md` - 分派实现者子智能体
- `./spec-reviewer-prompt.md` - 分派规范合规性审查者子智能体
- `./code-quality-reviewer-prompt.md` - 分派代码质量审查者子智能体

## 示例工作流

```
您：我正在使用 superpowers-subagent-execution 技能来执行此计划。

[读取计划文件一次：docs/plans/feature-plan.md]
[提取所有 5 个任务（含完整文本和上下文）]
[创建 TodoWrite，包含所有任务]

任务 1：钩子安装脚本

[获取任务 1 文本和上下文（已提取）]
[分派实现子智能体，提供完整任务文本 + 上下文]

实现者："开始之前 - 钩子应该安装在用户级还是系统级？"

您："用户级（~/.config/superpowers/hooks/）"

实现者："明白了。现在开始实现..."
[稍后] 实现者：
  - 实现了 install-hook 命令
  - 添加了测试，5/5 通过
  - 自我审查：发现遗漏了 --force 标志，已添加
  - 已提交

[分派规范合规性审查者]
规范审查者：✅ 符合规范 - 所有要求已满足，无额外功能

[获取 git SHA，分派代码质量审查者]
代码审查者：优点：测试覆盖率好，代码清晰。问题：无。已批准。

[标记任务 1 完成]

任务 2：恢复模式

[获取任务 2 文本和上下文（已提取）]
[分派实现子智能体，提供完整任务文本 + 上下文]

实现者：[无问题，继续]
实现者：
  - 添加了 verify/repair 模式
  - 8/8 测试通过
  - 自我审查：一切正常
  - 已提交

[分派规范合规性审查者]
规范审查者：❌ 问题：
  - 遗漏：进度报告（规范要求"每 100 项报告一次"）
  - 额外：添加了 --json 标志（未请求）

[实现者修复问题]
实现者：删除了 --json 标志，添加了进度报告

[规范审查者重新审查]
规范审查者：✅ 现在符合规范

[分派代码质量审查者]
代码审查者：优点：扎实。问题（重要）：魔法数字（100）

[实现者修复]
实现者：提取了 PROGRESS_INTERVAL 常量

[代码审查者重新审查]
代码审查者：✅ 已批准

[标记任务 2 完成]

...

[所有任务完成后]
[分派最终代码审查者]
最终审查者：所有要求已满足，准备合并

完成！
```

## 优势

**vs. 手动执行：**
- 子智能体自然遵循 TDD
- 每个任务使用新上下文（无混淆）
- 并行安全（子智能体不会互相干扰）
- 子智能体可以提问（工作前和工作中）

**vs. 并行会话执行：**
- 同一会话（无交接）
- 持续进度（无等待）
- 自动审查检查点

**效率提升：**
- 无文件读取开销（控制器提供完整文本）
- 控制器精确策划所需上下文
- 子智能体预先获得完整信息
- 问题在工作开始前浮现（而非之后）

**质量门控：**
- 自我审查在交接前捕获问题
- 两阶段审查：规范合规性，然后代码质量
- 审查循环确保修复实际有效
- 规范合规性防止过度/不足构建
- 代码质量确保实现构建良好

**成本：**
- 更多子智能体调用（每个任务：实现者 + 2 个审查者）
- 控制器做更多准备工作（预先提取所有任务）
- 审查循环增加迭代
- 但早期捕获问题（比后期调试更便宜）

## 红旗警告

**永远不要：**
- 在 main/master 分支上开始实现（未经用户明确同意）
- 跳过审查（规范合规性或代码质量）
- 在未修复问题的情况下继续
- 并行分派多个实现子智能体（会冲突）
- 让子智能体读取计划文件（应提供完整文本）
- 跳过场景设置上下文（子智能体需要理解任务在哪里）
- 忽略子智能体的问题（在让他们继续前回答）
- 在规范合规性上接受"差不多"（审查者发现问题 = 未完成）
- 跳过审查循环（审查者发现问题 = 实现者修复 = 重新审查）
- 让实现者自我审查替代实际审查（两者都需要）
- **在规范合规性 ✅ 之前开始代码质量审查**（顺序错误）
- 在任一审查有未解决问题时移至下一任务

**如果子智能体提问：**
- 清晰完整地回答
- 如需要提供额外上下文
- 不要催促他们进入实现

**如果审查者发现问题：**
- 实现者（同一子智能体）修复
- 审查者重新审查
- 重复直到批准
- 不要跳过重新审查

**如果子智能体任务失败：**
- 分派修复子智能体，提供具体指令
- 不要尝试手动修复（上下文污染）

## 集成

**必需的工作流技能：**
- **superpowers-git-worktree** - 必需：开始前设置隔离工作空间
- **superpowers-task-planning** - 创建此技能执行的计划
- **superpowers-finishing-branch** - 所有任务完成后完成开发

**子智能体应使用：**
- **tdd-workflow** - 子智能体为每个任务遵循 TDD

**替代工作流：**
- **executing-plans** - 用于并行会话而非同一会话执行

## 参考

参见 helpers.md#子智能体并行执行模式 了解详细的执行协调规范
参见 helpers.md#两阶段审查工作流 了解审查流程细节
