# 分阶段工作流（Workflow）命令

启动完整的分阶段项目工作流：需求分析 → 设计 → 开发 → 测试 → 部署维护。

## 用法

```
/workflow                    — 启动新项目工作流
/workflow resume             — 恢复中断的工作流
/workflow status             — 查看当前工作流状态
/workflow --phase 2          — 从指定阶段开始
/workflow --level 大         — 指定项目规模（小/中/大）
```

## 指令（Instructions）

### 启动流程

1. **项目状态扫描**（自动调用 `/project-scan --phase --save`）
   - 扫描项目技术栈、目录结构、已有产物
   - 检测五阶段对应的文档和代码是否已存在
   - 生成项目状态快照，写入 file-memory
   - 推荐起始阶段（跳过已完成的阶段）

2. **项目分级评估**
   - 基于扫描结果自动评估项目规模（小/中/大）
   - 结合源文件数、代码行数、模块数进行判断
   - 向用户确认分级结果和推荐的起始阶段

3. **初始化 file-memory**
   - 在 `.claude/plans/workflow-{项目名}/` 创建三文件
   - 记录项目名称、分级、启动时间
   - 将项目状态快照写入 task_plan.md

4. **进入推荐阶段**（默认阶段 1，或根据扫描结果跳转）
   - 如果扫描发现已有需求文档 → 跳过阶段 1
   - 如果扫描发现已有 PRD + 架构文档 → 跳过阶段 1-2
   - 如果扫描发现已有代码但无测试 → 直接进入阶段 4
   - 用户可以覆盖推荐，手动选择起始阶段
   - 调用对应阶段的智能体/技能

### 阶段切换

每个阶段结束时：
1. 执行门禁检查（建议性）
2. 向用户展示检查结果
3. 提供选项：继续 / 深入 / 跳过

### 五阶段详情

| 阶段 | 名称 | 调用的智能体/技能 | 产出物 |
|------|------|------------------|--------|
| 1 | 需求分析 | business-analyst | Doc/BRIEF-{项目名}.md |
| 2 | 设计 | product-manager + architect | Doc/PRD-{项目名}.md + Doc/ARCH-{项目名}.md |
| 3 | 开发 | planner + tdd-guide | Doc/SPRINT-{项目名}.md + 代码 |
| 4 | 测试 | e2e-runner + tdd-guide | 测试报告 |
| 5 | 部署维护 | verification-loop | 验证报告 |

### 门禁检查内容

门禁检查分为两层：产物检测（自动）+ 质量检查（建议性）。

**阶段 1 → 2（需求完整性）：**
- 🔍 自动检测：`Doc/BRIEF-*.md` 是否存在
- ☑️ 质量检查：有明确的目标（SMART 格式）、有用户画像、有核心需求列表、有成功指标

**阶段 2 → 3（设计完整性）：**
- 🔍 自动检测：`Doc/PRD-*.md` + `Doc/ARCH-*.md` 是否存在
- ☑️ 质量检查：PRD 已完成、技术架构已确定、优先级已排序、验收标准已定义

**阶段 3 → 4（开发完整性）：**
- 🔍 自动检测：`src/` 下是否有代码文件、`Doc/SPRINT-*.md` 是否存在
- ☑️ 质量检查：计划已分解为可执行任务、用户故事完整、依赖关系明确

**阶段 4 → 5（质量达标）：**
- 🔍 自动检测：测试文件是否存在、运行 `npm test --coverage`（或对应命令）获取实际覆盖率
- ☑️ 质量检查：测试覆盖率达标（80%+）、构建通过、安全扫描通过

### 恢复流程

执行 `/workflow resume` 时：
1. 运行 `/project-scan --save` 刷新项目状态快照
2. 读取 `.claude/plans/workflow-*/` 下的三文件
3. 对比快照与 file-memory 记录，检测离线期间的变化
4. 读取 Doc/ 目录下已产出的文档
5. 展示当前状态、进度和变化摘要
6. 从中断的阶段继续（如果项目状态已超前，建议跳转）

## 项目分级参考

项目分级现在基于 `/project-scan` 的实际数据，而非仅靠用户描述：

| 规模 | 判断标准（自动检测） | 文档深度 | 每轮问题数 |
|------|---------------------|---------|-----------|
| 小 | 源文件 <3、代码 <500 行、单一模块 | 精简版 | 3-4 题 |
| 中 | 源文件 3-10、代码 500-5000 行、多模块 | 标准 | 4-6 题 |
| 大 | 源文件 10+、代码 5000+ 行、多包/多服务 | 完整版 | 6-10 题 |

## 图表格式

- 复杂图表（架构图、序列图）：使用 Mermaid 语法
- 简单流程：使用 ASCII 框图

## 注意事项

- 门禁检查是建议性的，用户可以选择跳过
- 每个阶段开始时提示用户可以跳过或深入
- 所有文档输出到 Doc/ 目录
- 使用 file-memory 确保中断可恢复
- 小项目可以跳过阶段 1-2，直接从阶段 3 开始
